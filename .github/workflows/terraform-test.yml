name: Terraform Test

on:
  push:
    branches: [ main, infra/dev ]
    paths:
      - 'infra/terraform/**'
      - '.github/workflows/terraform-test.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'infra/terraform/**'
      - '.github/workflows/terraform-test.yml'

env:
  AWS_DEFAULT_REGION: ap-northeast-2
  TF_VERSION: 1.5.0
  GO_VERSION: 1.21

jobs:
  # ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ (ë³‘ë ¬ ì‹¤í–‰)
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        test-dir: [kms, ec2]
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_DEFAULT_REGION }}

    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Run Unit Tests - ${{ matrix.test-dir }}
      working-directory: infra/terraform/test/unit/${{ matrix.test-dir }}
      timeout-minutes: 45
      run: |
        go mod download
        # KMS í…ŒìŠ¤íŠ¸ ìˆœì°¨ ì‹¤í–‰ (-p 1)ìœ¼ë¡œ AWS API ì œí•œ ë°©ì§€
        go test -v -timeout 40m -p 1

  # í†µí•© í…ŒìŠ¤íŠ¸ (KMS ì—†ì´ - ì•ˆì •ì ì´ê³  ë¹ ë¦„)
  integration-test-no-kms:
    name: Integration Test (No KMS)
    runs-on: ubuntu-latest
    needs: unit-tests
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'run-integration-tests'))
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_DEFAULT_REGION }}

    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Run Integration Test (No KMS)
      working-directory: infra/terraform/test/integration/kms_ec2
      run: |
        go mod download
        go test -v -timeout 45m -run TestEC2WithoutKMS
      env:
        TF_LOG: INFO

  # ì™„ì „í•œ í†µí•© í…ŒìŠ¤íŠ¸ (KMS í¬í•¨ - ì„ íƒì  ì‹¤í–‰)
  integration-test-full:
    name: Integration Test (Full with KMS)
    runs-on: ubuntu-latest
    needs: unit-tests
    # ìˆ˜ë™ íŠ¸ë¦¬ê±° ë˜ëŠ” íŠ¹ì • ë¼ë²¨ì´ ìžˆì„ ë•Œë§Œ ì‹¤í–‰
    if: github.event_name == 'workflow_dispatch' || contains(github.event.pull_request.labels.*.name, 'run-full-integration-tests')
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_DEFAULT_REGION }}

    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Run Full Integration Test (with KMS)
      working-directory: infra/terraform/test/integration/kms_ec2
      run: |
        go mod download
        go test -v -timeout 60m -run TestKubernetesClusterIntegration
      env:
        TF_LOG: INFO

  # í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-test-no-kms]
    if: always()
    
    steps:
    - name: Test Results Summary
      run: |
        echo "## ðŸ§ª í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| í…ŒìŠ¤íŠ¸ ìœ í˜• | ìƒíƒœ |" >> $GITHUB_STEP_SUMMARY
        echo "|------------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ (KMS) | ${{ needs.unit-tests.result == 'success' && 'âœ… í†µê³¼' || 'âŒ ì‹¤íŒ¨' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ (EC2) | ${{ needs.unit-tests.result == 'success' && 'âœ… í†µê³¼' || 'âŒ ì‹¤íŒ¨' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| í†µí•© í…ŒìŠ¤íŠ¸ (KMS ì—†ì´) | ${{ needs.integration-test-no-kms.result == 'success' && 'âœ… í†µê³¼' || needs.integration-test-no-kms.result == 'skipped' && 'â­ï¸ ê±´ë„ˆëœ€' || 'âŒ ì‹¤íŒ¨' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ ì°¸ê³ ì‚¬í•­" >> $GITHUB_STEP_SUMMARY
        echo "- **ê¸°ë³¸ í†µí•© í…ŒìŠ¤íŠ¸**: KMS ì—†ì´ ì‹¤í–‰ (ë¹ ë¥´ê³  ì•ˆì •ì )" >> $GITHUB_STEP_SUMMARY
        echo "- **ì™„ì „í•œ í†µí•© í…ŒìŠ¤íŠ¸**: ìˆ˜ë™ íŠ¸ë¦¬ê±° ë˜ëŠ” 'run-full-integration-tests' ë¼ë²¨ í•„ìš”" >> $GITHUB_STEP_SUMMARY
        echo "- **PR í†µí•© í…ŒìŠ¤íŠ¸**: 'run-integration-tests' ë¼ë²¨ ì¶”ê°€ ì‹œ ì‹¤í–‰" >> $GITHUB_STEP_SUMMARY 