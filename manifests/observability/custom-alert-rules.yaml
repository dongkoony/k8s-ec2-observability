apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: k8s-ec2-observability-alerts
  namespace: monitoring
  labels:
    prometheus: kube-prometheus
    role: alert-rules
    release: prometheus-stack
spec:
  groups:
  - name: critical-system-alerts
    interval: 30s
    rules:
    # ğŸš¨ ë§ˆìŠ¤í„°ë…¸ë“œ CPU ê³¼ë¶€í•˜ (t3.medium íŠ¹í™”)
    - alert: MasterNodeHighCPU
      expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle",instance=~".*ip-10-0-1-34.*"}[5m])) * 100) > 95
      for: 2m
      labels:
        severity: critical
        component: node
        node_type: master
      annotations:
        summary: "ğŸš¨ ë§ˆìŠ¤í„°ë…¸ë“œ CPU ì‚¬ìš©ë¥  ì‹¬ê° (95% ì´ˆê³¼)"
        description: "ë§ˆìŠ¤í„°ë…¸ë“œ {{ $labels.instance }}ì˜ CPU ì‚¬ìš©ë¥ ì´ {{ $value }}%ì…ë‹ˆë‹¤. t3.medium í™˜ê²½ì—ì„œ ë§¤ìš° ìœ„í—˜í•œ ìˆ˜ì¤€ì…ë‹ˆë‹¤."
        runbook_url: "https://github.com/dongkoony/k8s-ec2-observability/blob/main/docs/runbooks/high-cpu.md"
        
    # ğŸš¨ ë§ˆìŠ¤í„°ë…¸ë“œ ë©”ëª¨ë¦¬ ë¶€ì¡± (4GB ê¸°ì¤€)
    - alert: MasterNodeHighMemory
      expr: (1 - (node_memory_MemAvailable_bytes{instance=~".*ip-10-0-1-34.*"} / node_memory_MemTotal_bytes{instance=~".*ip-10-0-1-34.*"})) * 100 > 85
      for: 3m
      labels:
        severity: critical
        component: node
        node_type: master
      annotations:
        summary: "ğŸš¨ ë§ˆìŠ¤í„°ë…¸ë“œ ë©”ëª¨ë¦¬ ë¶€ì¡± (85% ì´ˆê³¼)"
        description: "ë§ˆìŠ¤í„°ë…¸ë“œì˜ ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ ì´ {{ $value }}%ì…ë‹ˆë‹¤. 4GB í™˜ê²½ì—ì„œ OOM ìœ„í—˜ì´ ë†’ìŠµë‹ˆë‹¤."
        
    # ğŸš¨ ë‹¤ì¤‘ Pod Pending ìƒíƒœ (ë¦¬ì†ŒìŠ¤ ë¶€ì¡± ì§•ì¡°)
    - alert: MultiplePodsPending
      expr: count(kube_pod_status_phase{phase="Pending"}) > 2
      for: 5m
      labels:
        severity: critical
        component: pod-scheduler
      annotations:
        summary: "ğŸš¨ ë‹¤ìˆ˜ì˜ Podê°€ Pending ìƒíƒœ ({{ $value }}ê°œ)"
        description: "{{ $value }}ê°œì˜ Podê°€ 5ë¶„ ì´ìƒ Pending ìƒíƒœì…ë‹ˆë‹¤. ë¦¬ì†ŒìŠ¤ ë¶€ì¡±ì´ë‚˜ ìŠ¤ì¼€ì¤„ë§ ë¬¸ì œê°€ ì˜ì‹¬ë©ë‹ˆë‹¤."
        
    # ğŸš¨ Prometheus ì„œë²„ ë‹¤ìš´
    - alert: PrometheusDown
      expr: up{job="prometheus-kube-prometheus-prometheus"} == 0
      for: 1m
      labels:
        severity: critical
        component: monitoring
      annotations:
        summary: "ğŸš¨ Prometheus ì„œë²„ ë‹¤ìš´"
        description: "Prometheus ì„œë²„ê°€ 1ë¶„ ì´ìƒ ì‘ë‹µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤."

  - name: warning-system-alerts
    interval: 60s
    rules:
    # âš ï¸ ë†’ì€ CPU ì‚¬ìš©ë¥  (80% ê²½ê³ )
    - alert: HighCPUUsage
      expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
      for: 5m
      labels:
        severity: warning
        component: node
      annotations:
        summary: "âš ï¸ ë†’ì€ CPU ì‚¬ìš©ë¥  ê°ì§€ ({{ $value }}%)"
        description: "ë…¸ë“œ {{ $labels.instance }}ì˜ CPU ì‚¬ìš©ë¥ ì´ {{ $value }}%ì…ë‹ˆë‹¤. ë¦¬ì†ŒìŠ¤ ìµœì í™”ê°€ í•„ìš”í•©ë‹ˆë‹¤."
        
    # âš ï¸ Pod ì¬ì‹œì‘ ë£¨í”„
    - alert: PodRestartLoop
      expr: increase(kube_pod_container_status_restarts_total[30m]) > 3
      for: 10m
      labels:
        severity: warning
        component: pod
      annotations:
        summary: "âš ï¸ Pod ì¬ì‹œì‘ ë£¨í”„ ê°ì§€"
        description: "Pod {{ $labels.pod }} ({{ $labels.namespace }})ê°€ 30ë¶„ ë‚´ì— {{ $value }}íšŒ ì¬ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤."
        
    # âš ï¸ Linkerd ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ ì´ìŠˆ
    - alert: LinkerdControlPlaneIssue
      expr: up{job="linkerd-controller"} == 0
      for: 3m
      labels:
        severity: warning
        component: service-mesh
      annotations:
        summary: "âš ï¸ Linkerd ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ ë¬¸ì œ"
        description: "Linkerd ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ì´ 3ë¶„ ì´ìƒ ì‘ë‹µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
        
    # âš ï¸ ë””ìŠ¤í¬ ê³µê°„ ë¶€ì¡±
    - alert: LowDiskSpace
      expr: (1 - (node_filesystem_avail_bytes{mountpoint="/",fstype!="tmpfs"} / node_filesystem_size_bytes{mountpoint="/",fstype!="tmpfs"})) * 100 > 80
      for: 10m
      labels:
        severity: warning
        component: storage
      annotations:
        summary: "âš ï¸ ë””ìŠ¤í¬ ê³µê°„ ë¶€ì¡± ({{ $value }}%)"
        description: "ë…¸ë“œ {{ $labels.instance }}ì˜ ë£¨íŠ¸ íŒŒí‹°ì…˜ ì‚¬ìš©ë¥ ì´ {{ $value }}%ì…ë‹ˆë‹¤."

  - name: bookinfo-application-alerts
    interval: 60s
    rules:
    # ğŸ“± Bookinfo ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒíƒœ
    - alert: BookinfoServiceDown
      expr: up{job="bookinfo-productpage"} == 0
      for: 3m
      labels:
        severity: warning
        component: application
        service: bookinfo
      annotations:
        summary: "ğŸ“± Bookinfo ProductPage ì„œë¹„ìŠ¤ ë‹¤ìš´"
        description: "Bookinfo ProductPage ì„œë¹„ìŠ¤ê°€ 3ë¶„ ì´ìƒ ì‘ë‹µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
        
    # ğŸ“± Bookinfo ì‘ë‹µ ì‹œê°„ ì§€ì—°
    - alert: BookinfoHighLatency
      expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{job="bookinfo-productpage"}[5m])) > 2
      for: 5m
      labels:
        severity: warning
        component: application
        service: bookinfo
      annotations:
        summary: "ğŸ“± Bookinfo ì‘ë‹µ ì‹œê°„ ì§€ì—° ({{ $value }}ì´ˆ)"
        description: "Bookinfo ProductPageì˜ 95% ì‘ë‹µ ì‹œê°„ì´ {{ $value }}ì´ˆì…ë‹ˆë‹¤. ì„±ëŠ¥ ìµœì í™”ê°€ í•„ìš”í•©ë‹ˆë‹¤."

  - name: self-managed-k8s-alerts
    interval: 90s
    rules:
    # ğŸ—ï¸ ë§ˆìŠ¤í„°ë…¸ë“œ ê³¼ë¶€í•˜ (ìì²´ ê´€ë¦¬í˜• íŠ¹í™”)
    - alert: MasterNodeOverloaded
      expr: count(kube_pod_info{node=~".*ip-10-0-1-34.*"}) > 45
      for: 10m
      labels:
        severity: warning
        component: self-managed
      annotations:
        summary: "ğŸ—ï¸ ë§ˆìŠ¤í„°ë…¸ë“œ ê³¼ë¶€í•˜ ({{ $value }}ê°œ Pod)"
        description: "ë§ˆìŠ¤í„°ë…¸ë“œì— {{ $value }}ê°œì˜ Podê°€ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤. ìì²´ ê´€ë¦¬í˜• í™˜ê²½ì—ì„œ ë„ˆë¬´ ë§ì€ ë¶€í•˜ì…ë‹ˆë‹¤."
        
    # ğŸ—ï¸ ì›Œì»¤ë…¸ë“œ ìœ íœ´ ìƒíƒœ
    - alert: WorkerNodeUnderutilized
      expr: count(kube_pod_info{node!~".*ip-10-0-1-34.*"}) < 5
      for: 30m
      labels:
        severity: info
        component: self-managed
      annotations:
        summary: "ğŸ—ï¸ ì›Œì»¤ë…¸ë“œ ì €ì‚¬ìš©ë¥  ({{ $value }}ê°œ Podë§Œ ì‹¤í–‰)"
        description: "ì›Œì»¤ë…¸ë“œë“¤ì— {{ $value }}ê°œì˜ Podë§Œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤. ë¦¬ì†ŒìŠ¤ ì¬ë¶„ë°°ë¥¼ ê³ ë ¤í•˜ì„¸ìš”."
        
    # ğŸ—ï¸ PVC ìƒì„± ì‹¤íŒ¨ (ìì²´ ê´€ë¦¬í˜• í™˜ê²½)
    - alert: PVCCreationFailed
      expr: kube_persistentvolumeclaim_status_phase{phase="Pending"} > 0
      for: 15m
      labels:
        severity: warning
        component: storage
      annotations:
        summary: "ğŸ—ï¸ PVC ìƒì„± ì‹¤íŒ¨"
        description: "PVC {{ $labels.persistentvolumeclaim }} ({{ $labels.namespace }})ê°€ 15ë¶„ ì´ìƒ Pending ìƒíƒœì…ë‹ˆë‹¤."

  - name: operational-kpi-alerts
    interval: 120s
    rules:
    # ğŸ“Š ìë™ë³µêµ¬ ì‹œìŠ¤í…œ íŠ¸ë¦¬ê±°
    - alert: AutoRecoveryTrigger
      expr: (count(kube_pod_container_status_restarts_total) - count(kube_pod_container_status_restarts_total offset 10m)) > 5
      for: 2m
      labels:
        severity: info
        component: auto-recovery
      annotations:
        summary: "ğŸ“Š ìë™ë³µêµ¬ ì‹œìŠ¤í…œ íŠ¸ë¦¬ê±° (10ë¶„ê°„ {{ $value }}íšŒ ì¬ì‹œì‘)"
        description: "ìµœê·¼ 10ë¶„ê°„ {{ $value }}íšŒì˜ Pod ì¬ì‹œì‘ì´ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ìë™ë³µêµ¬ ì‹œìŠ¤í…œì´ ì‘ë™í•´ì•¼ í•©ë‹ˆë‹¤."
        
    # ğŸ“Š ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ ê±´ê°•ì„±
    - alert: MonitoringHealthCheck
      expr: up{job=~".*prometheus.*|.*grafana.*|.*alertmanager.*"} == 0
      for: 5m
      labels:
        severity: warning
        component: monitoring
      annotations:
        summary: "ğŸ“Š ëª¨ë‹ˆí„°ë§ ì»´í¬ë„ŒíŠ¸ ë‹¤ìš´"
        description: "ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œì˜ {{ $labels.job }} ì»´í¬ë„ŒíŠ¸ê°€ 5ë¶„ ì´ìƒ ë‹¤ìš´ë˜ì—ˆìŠµë‹ˆë‹¤."
        
    # ğŸ“Š ì¼ì¼ ìš´ì˜ ì„±ê³µë¥  KPI
    - alert: DailyOperationalKPI
      expr: (count(kube_pod_status_phase{phase="Running"}) / count(kube_pod_info)) * 100 < 85
      for: 30m
      labels:
        severity: info
        component: kpi
      annotations:
        summary: "ğŸ“Š ì¼ì¼ ìš´ì˜ ì„±ê³µë¥  ë‚®ìŒ ({{ $value }}%)"
        description: "í˜„ì¬ Pod ì‹¤í–‰ ì„±ê³µë¥ ì´ {{ $value }}%ì…ë‹ˆë‹¤. ëª©í‘œ ì„±ê³µë¥  85% ë¯¸ë‹¬ì…ë‹ˆë‹¤."
        
    # ğŸ“Š Linkerd mTLS ì•”í˜¸í™”ìœ¨
    - alert: LinkerdmTLSCoverage
      expr: (count(kube_pod_info{pod=~".*-.*-.*"}) - count(kube_pod_info{pod=~".*linkerd-proxy.*"})) / count(kube_pod_info{pod=~".*-.*-.*"}) * 100 > 20
      for: 20m
      labels:
        severity: info
        component: security
      annotations:
        summary: "ğŸ“Š Linkerd mTLS ì ìš©ë¥  ë‚®ìŒ"
        description: "ì•½ {{ $value }}%ì˜ Podê°€ Linkerd í”„ë¡ì‹œ ì—†ì´ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤. ë³´ì•ˆ ê°•í™”ê°€ í•„ìš”í•©ë‹ˆë‹¤." 